library(readxl)
library(reshape2)
library(dplyr)
getwd()
setwd("C:/R/RStudio/Projects/HW/Rex2")
# ==========================================================================================================================================================================================================================================================================================
# 1. 시작 전 기존 작업 data 삭제 ==============================================================================================================================
rm(list=ls())

# =======================================================================================================================================================================================================================================================================
# 2.str 함수로 세트 속성 확인 ==============================================================================================================================
subway_time_df <- read.csv("C:/R/RStudio/Projects/rawdata/data2/대전광역시도시철도공사_시간대별 승하차인원_2020년01월_05월.csv")
str(subway_time_df)
# 'data.frame':	6688 obs. of  28 variables:
# $ 날짜    : chr  "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" ...
# $ 역번호  : int  1101 1101 1102 1102 1103 1103 1104 1104 1105 1105 ...
# $ 역명    : chr  "판암" "판암" "신흥" "신흥" ...
# $ 구분    : chr  "승차" "하차" "승차" "하차" ...
# $ X03.04시: int  0 0 0 0 0 0 0 0 0 0 ...
# $ X04.05시: int  0 0 1 0 0 0 0 0 0 0 ...
# $ X05.06시: int  40 16 30 5 39 37 16 66 34 16 ...
# $ X06.07시: int  41 72 26 20 40 43 73 144 35 42 ...
# $ X07.08시: int  68 49 20 27 50 47 76 165 26 49 ...
# $ X08.09시: int  127 63 56 27 107 41 153 256 47 64 ...
# $ X09.10시: int  163 78 92 26 131 63 230 332 68 197 ...
# $ X10.11시: int  140 72 53 35 133 49 341 393 74 185 ...
# $ X11.12시: int  190 95 90 37 160 75 401 475 117 312 ...
# $ X12.13시: int  199 118 91 40 152 77 407 617 106 436 ...
# $ X13.14시: int  206 107 97 38 178 124 492 657 222 569 ...
# $ X14.15시: int  185 153 85 65 168 151 608 657 288 646 ...
# $ X15.16시: int  161 212 63 92 181 171 760 472 416 566 ...
# $ X16.17시: int  180 158 53 89 158 128 835 487 524 510 ...
# $ X17.18시: int  148 218 82 95 163 136 753 455 621 478 ...
# $ X18.19시: int  122 143 67 77 164 158 644 380 529 375 ...
# $ X19.20시: int  93 148 32 73 109 119 567 337 401 227 ...
# $ X20.21시: int  79 120 31 46 91 102 607 276 391 148 ...
# $ X21.22시: int  41 132 17 52 73 172 580 235 394 120 ...
# $ X22.23시: int  35 118 12 38 56 164 504 83 253 71 ...
# $ X23.00시: int  16 60 6 29 34 133 181 33 126 68 ...
# $ X00.01시: int  0 11 0 2 0 10 0 1 0 3 ...
# $ X01.02시: int  0 0 0 0 0 0 0 0 0 0 ...
# $ X02.03시: int  0 0 0 0 0 0 0 0 0 0 ...

#2-1."날짜" 열의 속성은 무엇인가요?
print("날짜 열의 속성은 chr 문자형입니다.")

#2-2 "날짜: 열의 데이터 속성을 Date로 변경하세요
#case1
subway_time_df$날짜 <- as.Date(subway_time_df$날짜, format='%Y-%m-%d')
head(subway_time_df$날짜)
# [1] "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01"
str(subway_time_df$날짜)
# Date[1:6688], format: "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" "2020-01-01" ...

#case2
subway_time_df$날짜 <- as.Date(subway_time_df$날짜)
subway_time_df$날짜

# ============================================================================================================================================================================================================================================================

#3. 변수를 영어로 바꾸기 ==============================================================================================================================
subway_time_df<-rename(subway_time_df,yyyymmdd="날짜",station_num="역번호",station="역명",ride_getoff="구분")

#나머지열이름 변경을 위한 전처리
head(subway_time_df) #열이름 순서 확인
#         날짜 역번호 역명 구분 X03.04시 X04.05시 X05.06시 X06.07시 X07.08시 X08.09시 X09.10시 X10.11시 X11.12시 X12.13시 X13.14시 X14.15시 X15.16시 X16.17시
# 1 2020-01-01   1101 판암 승차        0        0       40       41       68      127      163      140      190      199      206      185      161      180
# 2 2020-01-01   1101 판암 하차        0        0       16       72       49       63       78       72       95      118      107      153      212      158
# 3 2020-01-01   1102 신흥 승차        0        1       30       26       20       56       92       53       90       91       97       85       63       53
# 4 2020-01-01   1102 신흥 하차        0        0        5       20       27       27       26       35       37       40       38       65       92       89
# 5 2020-01-01   1103 대동 승차        0        0       39       40       50      107      131      133      160      152      178      168      181      158
# 6 2020-01-01   1103 대동 하차        0        0       37       43       47       41       63       49       75       77      124      151      171      128
# X17.18시 X18.19시 X19.20시 X20.21시 X21.22시 X22.23시 X23.00시 X00.01시 X01.02시 X02.03시
# 1      148      122       93       79       41       35       16        0        0        0
# 2      218      143      148      120      132      118       60       11        0        0
# 3       82       67       32       31       17       12        6        0        0        0
# 4       95       77       73       46       52       38       29        2        0        0
# 5      163      164      109       91       73       56       34        0        0        0
# 6      136      158      119      102      172      164      133       10        0        0
length(subway_time_df)#마지막열 index 확인
#[1] 28


subway_time_df <- subway_time_df[,c(1:4,26:28,5:25)] # 열순서 변경 1:4는 날짜 역번호 역명 구분, 26:28은 X21.22시 X22.23시 X23.00시, 5:25는 나머지 시간대.
head(subway_time_df)
# 날짜 역번호 역명 구분 X00.01시 X01.02시 X02.03시 X03.04시 X04.05시 X05.06시 X06.07시 X07.08시 X08.09시 X09.10시 X10.11시 X11.12시 X12.13시 X13.14시
# 1 2020-01-01   1101 판암 승차        0        0        0        0        0       40       41       68      127      163      140      190      199      206
# 2 2020-01-01   1101 판암 하차       11        0        0        0        0       16       72       49       63       78       72       95      118      107
# 3 2020-01-01   1102 신흥 승차        0        0        0        0        1       30       26       20       56       92       53       90       91       97
# 4 2020-01-01   1102 신흥 하차        2        0        0        0        0        5       20       27       27       26       35       37       40       38
# 5 2020-01-01   1103 대동 승차        0        0        0        0        0       39       40       50      107      131      133      160      152      178
# 6 2020-01-01   1103 대동 하차       10        0        0        0        0       37       43       47       41       63       49       75       77      124
# X14.15시 X15.16시 X16.17시 X17.18시 X18.19시 X19.20시 X20.21시 X21.22시 X22.23시 X23.00시
# 1      185      161      180      148      122       93       79       41       35       16
# 2      153      212      158      218      143      148      120      132      118       60
# 3       85       63       53       82       67       32       31       17       12        6
# 4       65       92       89       95       77       73       46       52       38       29
# 5      168      181      158      163      164      109       91       73       56       34
# 6      151      171      128      136      158      119      102      172      164      133

sub_len = length(subway_time_df[,-c(1:4)]) #날짜,역번호, 역명, 구분 열 제외한 길이


for (i in 0:(sub_len-1)){ #날짜,역번호, 역명, 구분 열 제외한 길이 만큼 반복. 우선순위로 인해 (sub_len-1)와 같이 ()를 해줘야 한다.
  names(subway_time_df)[i+5]=sprintf("h%02d%02d",i,(i+1)%%24) # 날짜,역번호, 역명, 구분 열 제외하고 00 문자열 format으로 이름 재지정. 
  #열이름 h 00 01~23 00 중 h 00 01에서 01자리에 1을 더해 24로 나눈 나머지값
}
names(subway_time_df)
# [1] "yyyymmdd"    "station_num" "station"     "ride_getoff" "h0001"       "h0102"       "h0203"       "h0304"       "h0405"      
# [10] "h0506"       "h0607"       "h0708"       "h0809"       "h0910"       "h1011"       "h1112"       "h1213"       "h1314"      
# [19] "h1415"       "h1516"       "h1617"       "h1718"       "h1819"       "h1920"       "h2021"       "h2122"       "h2223"      
# [28] "h2300"  


# 수정해야할 반복되는 열이름이 많을 때는 이렇게 코딩할 필요가 있겠지만, 지금같은 경우에는 그냥 적는게 더 좋겠습니다.

# ===============================================================================================================================================================================================================================================================================================================================================================================

# 4.3번에서 변경한 변수 yyyymmdd에 있는 날짜를 기준으로 분류하여 날짜별로 txt로 저장하세요============================================================================================================================================================================================================================================================

Split1 <- split(subway_time_df, subway_time_df$yyyymmdd) #각 날짜이름으로 된 리스트 안에 데이터프레임이 있다.
class(Split1)# 리스트로 반환
# [1] "list"
names(Split1) #파일명으로 사용
# [1] "2020-01-01" "2020-01-02" "2020-01-03" "2020-01-04" "2020-01-05" "2020-01-06" "2020-01-07" "2020-01-08" "2020-01-09" "2020-01-10" "2020-01-11" "2020-01-12"
# [13] "2020-01-13" "2020-01-14" "2020-01-15" "2020-01-16" "2020-01-17" "2020-01-18" "2020-01-19" "2020-01-20" "2020-01-21" "2020-01-22" "2020-01-23" "2020-01-24"
# [25] "2020-01-25" "2020-01-26" "2020-01-27" "2020-01-28" "2020-01-29" "2020-01-30" "2020-01-31" "2020-02-01" "2020-02-02" "2020-02-03" "2020-02-04" "2020-02-05"
# [37] "2020-02-06" "2020-02-07" "2020-02-08" "2020-02-09" "2020-02-10" "2020-02-11" "2020-02-12" "2020-02-13" "2020-02-14" "2020-02-15" "2020-02-16" "2020-02-17"
# [49] "2020-02-18" "2020-02-19" "2020-02-20" "2020-02-21" "2020-02-22" "2020-02-23" "2020-02-24" "2020-02-25" "2020-02-26" "2020-02-27" "2020-02-28" "2020-02-29"
# [61] "2020-03-01" "2020-03-02" "2020-03-03" "2020-03-04" "2020-03-05" "2020-03-06" "2020-03-07" "2020-03-08" "2020-03-09" "2020-03-10" "2020-03-11" "2020-03-12"
# [73] "2020-03-13" "2020-03-14" "2020-03-15" "2020-03-16" "2020-03-17" "2020-03-18" "2020-03-19" "2020-03-20" "2020-03-21" "2020-03-22" "2020-03-23" "2020-03-24"
# [85] "2020-03-25" "2020-03-26" "2020-03-27" "2020-03-28" "2020-03-29" "2020-03-30" "2020-03-31" "2020-04-01" "2020-04-02" "2020-04-03" "2020-04-04" "2020-04-05"
# [97] "2020-04-06" "2020-04-07" "2020-04-08" "2020-04-09" "2020-04-10" "2020-04-11" "2020-04-12" "2020-04-13" "2020-04-14" "2020-04-15" "2020-04-16" "2020-04-17"
# [109] "2020-04-18" "2020-04-19" "2020-04-20" "2020-04-21" "2020-04-22" "2020-04-23" "2020-04-24" "2020-04-25" "2020-04-26" "2020-04-27" "2020-04-28" "2020-04-29"
# [121] "2020-04-30" "2020-05-01" "2020-05-02" "2020-05-03" "2020-05-04" "2020-05-05" "2020-05-06" "2020-05-07" "2020-05-08" "2020-05-09" "2020-05-10" "2020-05-11"
# [133] "2020-05-12" "2020-05-13" "2020-05-14" "2020-05-15" "2020-05-16" "2020-05-17" "2020-05-18" "2020-05-19" "2020-05-20" "2020-05-21" "2020-05-22" "2020-05-23"
# [145] "2020-05-24" "2020-05-25" "2020-05-26" "2020-05-27" "2020-05-28" "2020-05-29" "2020-05-30" "2020-05-31"
for (date in 1:length(names(Split1))){ # 일자 리스트 길이 만큼 반복
  form =sprintf('Daejeon_subway_%s.txt',gsub("-","",names(Split1))[date]) # gsub로 yyymmdd열 데이터에서 '-' 제거
  write.table(Split1[[date]],file=form) # 리스트 안 데이터 프레임만 저장
}

# ===============================================================================================================================================================================================================================================================================================================================================================================

# 5. 4번에서 생성한 일별 txt 파일을 하나씩 불러서 일별 최대 승차인원을 가지는 정류장 및 시간대를 구하시오.# ===============================================================================================================================================================================================================================================================================================================================================================================

getwd()
setwd("C:/R/RStudio/Projects/HW/Rex2")

max_month <- c(31,29,31,30,31,30,31,31,30,31,30,31)
sum(max_month) #1년 날짜수 확인 #2020은 윤달이므로 2월은 29일까지
# [1] 366
need_month <- max_month[1:5] #1월에서 5월까지만.

df_result <- data.frame()


for (month in 1:length(need_month)){ #1:5까지 반복
  for (day in 1:need_month[month]){ #1에서 각 달 최대 날짜 만큼 반복
    df_read <- read.table(file=sprintf('Daejeon_subway_2020%02d%02d.txt',month,day),header = TRUE, sep="")
    
    df_sub_melt <- df_read %>% 
      subset(ride_getoff=="승차") %>% #승차만 필터
      melt(id.vars = names(sub_getoff)[1:4])  #yyyymmdd station_num station ride_getoff 기준 melt
    
    df_sub <- subset(df_sub_melt,value==max(value))[c(1,3,5)] #melt한 값중 value가 가장 큰 행을 1(yyymmdd),3(staion),5(variable) 열 추출
    df_result <- bind_rows(df_result,df_sub) #df_result에 적재
  
  }
}
print(head(df_result))
#     yyyymmdd  station variable
# 1 2020-01-01     대전    h1617
# 2 2020-01-02 정부청사    h1819
# 3 2020-01-03 정부청사    h1819
# 4 2020-01-04     대전    h1617
# 5 2020-01-05     대전    h1617
# 6 2020-01-06 정부청사    h1819

#끝입니다. ===============================================================================

