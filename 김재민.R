#Jae-Min Kim 2020 07 09 homework01
# 김재민
library(readxl)


#1. 기존 작업에 있던 Data 모두 삭제
rm(list=ls())

#2. str 함수를 사용하여 데이터 속성 확인
subway_df <- read.csv("../rawdata/대전광역시_역별_수송실적.csv")
str(subway_df)

#결과
# 'data.frame':	22 obs. of  13 variables:
#   $ 연도    : int  2020 2020 2020 2020 2020 2020 2020 2020 2020 2020 ...
# $ 역번호  : int  1101 1102 1103 1104 1105 1106 1107 1108 1109 1110 ...
# $ 역명    : chr  "판암" "신흥" "대동" "대전" ...
# $ X1월승차: int  128432 56982 128125 334026 186599 65789 195727 124935 215117 148694 ...
# $ X1월하차: int  112353 49665 111533 327258 207634 70913 206843 114486 219133 160913 ...
# $ X2월승차: int  100092 45140 98494 227907 135093 49642 150934 99297 161984 115657 ...
# $ X2월하차: int  87988 39334 86686 223965 148384 54169 157877 92407 163355 126219 ...
# $ X3월승차: int  71716 32004 65793 145123 77624 35769 97774 69316 97435 77052 ...
# $ X3월하차: int  64084 27875 58454 144227 85910 38308 102279 63824 97672 84329 ...
# $ X4월승차: int  84142 36001 78283 189409 99793 41141 115110 78203 115539 88697 ...
# $ X4월하차: int  74939 31313 69118 188431 112023 44478 119196 72503 115511 97298 ...
# $ X5월승차: int  101009 42183 97264 250287 131212 48683 138647 94757 140200 104394 ...
# $ X5월하차: int  89941 37082 84747 243862 148421 53046 145223 87063 140848 114450 ...

# 3. 데이터 구조는 몇행 몇렬인가?
dim(subway_df)
#[1] 22 13

# 4. 데이터 세트의 변수명을 한글에서 영문으로 변경
#rename(subway_df,year='연도',station_num='역번호', station='역명', Jan_1='1월승차', Jan_2='1월하차',Feb_1='2월승차',Feb_2='2월하차')
names(subway_df)<-c("year","station_num","station","Jan_1","Jan_2","Feb_1","Feb_2","Mar_1","Mar_2","Apr_1","Apr_2","May_1","May_2")
head(subway_df)
#   year station_num station  Jan_1  Jan_2  Feb_1  Feb_2  Mar_1  Mar_2  Apr_1  Apr_2  May_1  May_2
# 1 2020        1101    판암 128432 112353 100092  87988  71716  64084  84142  74939 101009  89941
# 2 2020        1102    신흥  56982  49665  45140  39334  32004  27875  36001  31313  42183  37082
# 3 2020        1103    대동 128125 111533  98494  86686  65793  58454  78283  69118  97264  84747
# 4 2020        1104    대전 334026 327258 227907 223965 145123 144227 189409 188431 250287 243862
# 5 2020        1105  중앙로 186599 207634 135093 148384  77624  85910  99793 112023 131212 148421
# 6 2020        1106  중구청  65789  70913  49642  54169  35769  38308  41141  44478  48683  53046


#5.매월(1월~5월) 승하차 차이 계산
subway_df <- mutate(subway_df,Jan_diff=Jan_1-Jan_2,Feb_diff=Feb_1-Feb_2,Mar_diff=Mar_1-Mar_2,Apr_diff=Apr_1-Apr_2,May_diff=May_1-May_2)
subway_df
#    year station_num      station  Jan_1  Jan_2  Feb_1  Feb_2  Mar_1  Mar_2  Apr_1  Apr_2  May_1  May_2 Jan_diff Feb_diff Mar_diff Apr_diff May_diff
# 1  2020        1101         판암 128432 112353 100092  87988  71716  64084  84142  74939 101009  89941    16079    12104     7632     9203    11068
# 2  2020        1102         신흥  56982  49665  45140  39334  32004  27875  36001  31313  42183  37082     7317     5806     4129     4688     5101
# 3  2020        1103         대동 128125 111533  98494  86686  65793  58454  78283  69118  97264  84747    16592    11808     7339     9165    12517
# 4  2020        1104         대전 334026 327258 227907 223965 145123 144227 189409 188431 250287 243862     6768     3942      896      978     6425
# 5  2020        1105       중앙로 186599 207634 135093 148384  77624  85910  99793 112023 131212 148421   -21035   -13291    -8286   -12230   -17209
# 6  2020        1106       중구청  65789  70913  49642  54169  35769  38308  41141  44478  48683  53046    -5124    -4527    -2539    -3337    -4363
# 7  2020        1107 서대전네거리 195727 206843 150934 157877  97774 102279 115110 119196 138647 145223   -11116    -6943    -4505    -4086    -6576
# 8  2020        1108         오룡 124935 114486  99297  92407  69316  63824  78203  72503  94757  87063    10449     6890     5492     5700     7694
# 9  2020        1109         용문 215117 219133 161984 163355  97435  97672 115539 115511 140200 140848    -4016    -1371     -237       28     -648
# 10 2020        1110         탄방 148694 160913 115657 126219  77052  84329  88697  97298 104394 114450   -12219   -10562    -7277    -8601   -10056
# 11 2020        1111         시청 229647 240866 182695 191688 116903 121941 136378 142378 164595 173226   -11219    -8993    -5038    -6000    -8631
# 12 2020        1112     정부청사 186679 200239 148639 160014 101635 110765 114854 123820 137092 148250   -13560   -11375    -9130    -8966   -11158
# 13 2020        1113         갈마  91645  90480  69244  68864  44121  43567  53922  53223  66916  66213     1165      380      554      699      703
# 14 2020        1114         월평 112871 112888  85100  84009  52019  51219  63064  62184  74847  74260      -17     1091      800      880      587
# 15 2020        1115         갑천  28106  27546  22839  22154  16869  16022  19651  19034  23372  22570      560      685      847      617      802
# 16 2020        1116     유성온천 275787 283679 206932 212988 127497 129949 152974 156327 193167 197669    -7892    -6056    -2452    -3353    -4502
# 17 2020        1117         구암  73874  73272  55986  55453  37043  36740  46021  45758  56824  55828      602      533      303      263      996
# 18 2020        1118       현충원  62740  48412  45240  35353  29934  24833  37736  30618  47357  38773    14328     9887     5101     7118     8584
# 19 2020        1119 월드컵경기장  78014  69632  60104  53613  41544  37440  48933  43818  59232  53035     8382     6491     4104     5115     6197
# 20 2020        1120         노은 121305 128308  93228  98464  58535  62154  70214  74442  86650  91685    -7003    -5236    -3619    -4228    -5035
# 21 2020        1121         지족  78454  75856  63112  61533  42955  41829  45483  43831  54258  51867     2598     1579     1126     1652     2391
# 22 2020        1122         반석 219270 199901 173934 159166 112692 103645 134244 123919 165163 152487    19369    14768     9047    10325    12676

# 6. 1월 승차인원이 가장 많은 정류장을 가지는 행을 추출
subset(subway_df,Jan_1==max(Jan_1))
#   year station_num station  Jan_1  Jan_2  Feb_1  Feb_2  Mar_1  Mar_2  Apr_1  Apr_2  May_1  May_2 Jan_diff Feb_diff Mar_diff Apr_diff May_diff
# 4 2020        1104    대전 334026 327258 227907 223965 145123 144227 189409 188431 250287 243862     6768     3942      896      978     6425


#7.승하차 인원의 차이가 가장 큰 정류장과 해당 월(1~5월)을 찾으시오

library(reshape2)
subway_melt <- melt(subway_df, id.vars = c("station"), measure.vars = c("Jan_diff","Feb_diff","Mar_diff","Apr_diff","May_diff"))
head(subway_melt)

subway_melt[,3] <- abs(subway_melt[,3]) # 차이 비교이므로 절대값
head(subway_melt)
#   station variable value
# 1    판암 Jan_diff 16079
# 2    신흥 Jan_diff  7317
# 3    대동 Jan_diff 16592
# 4    대전 Jan_diff  6768
# 5  중앙로 Jan_diff 21035
# 6  중구청 Jan_diff  5124

subset(subway_melt,value==max(value))
#    station variable value
# 5  중앙로 Jan_diff 21035


#8. 기준열(year,station)과 변환열 (Jan_1,Mar_1)로 하여 1월 승차 3월 승차에 대해 데이터셋을 세로로 재배치하세요
subway_melt2 <- melt(subway_df, id.vars = c("year","station"), measure.vars = c("Jan_1","Mar_1"))
head(subway_melt2)
#   year station variable  value
# 1 2020    판암    Jan_1 128432
# 2 2020    신흥    Jan_1  56982
# 3 2020    대동    Jan_1 128125
# 4 2020    대전    Jan_1 334026
# 5 2020  중앙로    Jan_1 186599
# 6 2020  중구청    Jan_1  65789


#9 dcast 복원
subway_dcast <- dcast(subway_melt2, year + station ~ variable)
head(subway_dcast)

#   year station  Jan_1  Mar_1
# 1 2020    갈마  91645  44121
# 2 2020    갑천  28106  16869
# 3 2020    구암  73874  37043
# 4 2020    노은 121305  58535
# 5 2020    대동 128125  65793
# 6 2020    대전 334026 145123

#10 1월과 3월의 승차 인원 차이를 구하고 차이가 나는 이유를 각자 추측하시오. 가장 차이가 많이 나는 역은 어디인가요?

subway_dcast_diff<-mutate(subway_dcast,diff_abs=abs(Mar_1-Jan_1),diff=Mar_1-Jan_1,decr_per=round(100-(Mar_1/Jan_1*100)))
subway_dcast_diff
#    year      station  Jan_1  Mar_1   diff
# 1  2020         갈마  91645  44121  47524
# 2  2020         갑천  28106  16869  11237
# 3  2020         구암  73874  37043  36831
# 4  2020         노은 121305  58535  62770
# 5  2020         대동 128125  65793  62332
# 6  2020         대전 334026 145123 188903
# 7  2020         반석 219270 112692 106578
# 8  2020 서대전네거리 195727  97774  97953
# 9  2020         시청 229647 116903 112744
# 10 2020         신흥  56982  32004  24978
# 11 2020         오룡 124935  69316  55619
# 12 2020         용문 215117  97435 117682
# 13 2020 월드컵경기장  78014  41544  36470
# 14 2020         월평 112871  52019  60852
# 15 2020     유성온천 275787 127497 148290
# 16 2020     정부청사 186679 101635  85044
# 17 2020       중구청  65789  35769  30020
# 18 2020       중앙로 186599  77624 108975
# 19 2020         지족  78454  42955  35499
# 20 2020         탄방 148694  77052  71642
# 21 2020         판암 128432  71716  56716
# 22 2020       현충원  62740  29934  32806
arrange(subway_dcast_diff,desc(decr_per)) # 1월 대비 감소 비율 내림차순
#    year      station  Jan_1  Mar_1 diff_abs    diff decr_per
# 1  2020       중앙로 186599  77624   108975 -108975       58
# 2  2020         대전 334026 145123   188903 -188903       57
# 3  2020         용문 215117  97435   117682 -117682       55
# 4  2020         월평 112871  52019    60852  -60852       54
# 5  2020     유성온천 275787 127497   148290 -148290       54
# 6  2020         갈마  91645  44121    47524  -47524       52
# 7  2020         노은 121305  58535    62770  -62770       52
# 8  2020       현충원  62740  29934    32806  -32806       52
# 9  2020         구암  73874  37043    36831  -36831       50
# 10 2020 서대전네거리 195727  97774    97953  -97953       50
# 11 2020         대동 128125  65793    62332  -62332       49
# 12 2020         반석 219270 112692   106578 -106578       49
# 13 2020         시청 229647 116903   112744 -112744       49
# 14 2020         탄방 148694  77052    71642  -71642       48
# 15 2020 월드컵경기장  78014  41544    36470  -36470       47
# 16 2020     정부청사 186679 101635    85044  -85044       46
# 17 2020       중구청  65789  35769    30020  -30020       46
# 18 2020         오룡 124935  69316    55619  -55619       45
# 19 2020         지족  78454  42955    35499  -35499       45
# 20 2020         신흥  56982  32004    24978  -24978       44
# 21 2020         판암 128432  71716    56716  -56716       44
# 22 2020         갑천  28106  16869    11237  -11237       40


#(2) 차이난 (감소가 일어난)  원인은 무엇일까?
subset(subway_dcast_diff,decr_per==max(decr_per))[,'station']
# [1] "중앙로"
max_per <- subset(subway_dcast_diff,decr_per==max(decr_per))[,'decr_per']
# [1] 58
min_per <- subset(subway_dcast_diff,decr_per==min(decr_per))[,'decr_per']
# [1] 40
mean_per <- (max_per+min_per)/2
# [1] 49


#1월 대비 가장 많은 감소가 일어난 중앙로는 58% 감소하였습니다. 시내 유동인가가 줄어든 것을 볼수 있습니다.
# 2월 말 코로나 확산이 이뤄지며 사회적 거리두기, 타 지역 이동 감소로 인하여 지하철역 평균 49% 승차인원이 감소하였습니다.



#(3)가장 차이가 많이 나는 역
subset(subway_dcast_diff,diff_abs==max(diff_abs))[,'station']
# [1] "대전"
